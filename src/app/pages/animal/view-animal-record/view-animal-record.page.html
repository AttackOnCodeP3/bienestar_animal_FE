<app-general-container-component>
  <div class="d-flex justify-content-between align-items-center">
    <h1>Ver expediente animal</h1>
  </div>
</app-general-container-component>

<mat-form-field appearance="outline" class="w-100 mb-4">
  <mat-label>Seleccione el animal</mat-label>
  <mat-select
    [(ngModel)]="selectedAnimalId"
    (selectionChange)="onAnimalSelect($event.value)"
  >
    <mat-option *ngFor="let animal of animalList ?? []" [value]="animal.id">
      {{ animal.name }}
    </mat-option>
  </mat-select>
</mat-form-field>

@if (selectedAnimal) {
<mat-card class="mb-4">
  <mat-card-title>
    {{ selectedAnimal.name }} - {{ selectedAnimal.species?.name }}
  </mat-card-title>
  <mat-card-content>
    <div class="mb-2">
      <strong>Edad:</strong>
      {{ formatAge(selectedAnimal.age) }}
    </div>
    <div class="mb-2">
      <strong>Sexo:</strong>
      {{ selectedAnimal.sex?.name }}
    </div>
    <div class="mb-2">
      <strong>Peso:</strong>
      {{ selectedAnimal.weight }} kg
    </div>
    <div class="mb-2">
      <strong>Raza:</strong>
      {{ selectedAnimal.race?.name }}
    </div>
    <div class="mb-2">
      <strong>Tipo de animal:</strong>
      {{ selectedAnimal.animalType?.name }}
    </div>
    <div class="mb-2">
      <strong>Fecha de nacimiento:</strong>
      {{ selectedAnimal.birthDate }}
    </div>
  </mat-card-content>
</mat-card>

<mat-expansion-panel expanded="false" class="mb-4">
  <mat-expansion-panel-header>
    <mat-panel-title>
      <h2>Controles sanitarios</h2>
    </mat-panel-title>
  </mat-expansion-panel-header>
  @if (selectedAnimal?.sanitaryControls?.length > 0) {
  <table
    mat-table
    [dataSource]="selectedAnimal.sanitaryControls"
    class="mat-elevation-z1 w-100"
  >
    <ng-container matColumnDef="lastApplicationDate">
      <th mat-header-cell *matHeaderCellDef>Fecha aplicación</th>
      <td mat-cell *matCellDef="let control">
        {{ control.lastApplicationDate || 'N/A' }}
      </td>
    </ng-container>
    <ng-container matColumnDef="type">
      <th mat-header-cell *matHeaderCellDef>Tipo</th>
      <td mat-cell *matCellDef="let control">
        {{ control.sanitaryControlType?.name }}
      </td>
    </ng-container>
    <ng-container matColumnDef="productUsed">
      <th mat-header-cell *matHeaderCellDef>Producto usado</th>
      <td mat-cell *matCellDef="let control">
        {{ control.productUsed || 'N/A' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="typeDescription">
      <th mat-header-cell *matHeaderCellDef>Descripción</th>
      <td mat-cell *matCellDef="let control">
        {{ control.sanitaryControlType?.description || 'N/A' }}
      </td>
    </ng-container>
    <tr
      mat-header-row
      *matHeaderRowDef="['lastApplicationDate', 'type', 'productUsed', 'typeDescription']"
    ></tr>
    <tr
      mat-row
      *matRowDef="let row; columns: ['lastApplicationDate', 'type', 'productUsed', 'typeDescription'];"
    ></tr>
  </table>
  } @else {
  <p>No hay controles sanitarios registrados para este animal.</p>
  }
</mat-expansion-panel>

<mat-expansion-panel expanded="false" class="mb-4">
  <mat-expansion-panel-header>
    <mat-panel-title>
      <h2>Modelo 3D</h2>
    </mat-panel-title>
  </mat-expansion-panel-header>

  <app-glb-viewer
    [animalId]="selectedAnimal.id"
    [autoRotate]="true"
  ></app-glb-viewer>
</mat-expansion-panel>

<mat-expansion-panel expanded="false" class="mb-4">
  <mat-expansion-panel-header>
    <mat-panel-title>
      <h2>Ubicación en mapa</h2>
    </mat-panel-title>
  </mat-expansion-panel-header>
  <app-google-maps
    [lat]="selectedAnimal.latitude"
    [lng]="selectedAnimal.longitude"
  ></app-google-maps>
</mat-expansion-panel>
}
